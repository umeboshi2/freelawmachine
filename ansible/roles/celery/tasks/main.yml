---
###################################################################
#
#  Celery service role
#
###################################################################
- name: prepare and set ownership of  Celery directories
  become_user: root
  file:
    state: directory
    path: "{{ item }}"
    owner: "{{ celery_user }}"
    group: "{{ celery_user }}"
  with_items:
    - "{{ celery_run_directory }}"
    - "{{ celery_log_directory }}"
    
- name: install Celery via pip
  become_user: "{{ celery_user }}"
  pip: name=Celery virtualenv={{ virtualenv_directory }}

- name: install Celery daemon config
  become_user: root
  template: src=celeryd.sysv dest=/etc/init.d/celeryd mode=0755

- name: add logrotate settings
  become_user: root
  template: src=celery.logrotate dest=/etc/logrotate.d/celery

- name: start Celery service
  become_user: root
  service:
    name: celeryd
    state: started
    enabled: yes
